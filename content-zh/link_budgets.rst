.. _link-budgets-chapter:

##################
链路预算
##################

在本章中，我们将学习链路预算（Link Budget）这一概念，
其中主要包含发送/接收功率、路径损耗（Path Loss）、
天线增益（Antenna Gain）、噪声（Noise）和信噪比（缩写为 SNR 或 S/N）等细节。
最后，我们通过一个针对 ADS-B 系统的链路预算实例来加深理解。
ADS-B 是商用飞机使用的一种信号系统，用于实时共享飞机的位置和其他信息。

*************************
简介
*************************

链路预算是一种核算过程。它考虑发射机和接收机之间各种增益和损耗因素、描述无线链路中一个方向的性能。
由于大多数通信系统是双向的，所以我们需要对上行链路和下行链路分别进行预算。
链路预算的结果将指示接收机所需 SNR 水平。
当然，往往还需要进一步分析以确定该 SNR 是否满足我们所需的特定应用。

学习链路预算的目的往往不是真的去 “核算”，而是为了更系统地理解无线通信系统的整体框架。

得到一个大致的性能评估包含三个基本步骤：信号功率预算、噪声功率预算、将两者结合以计算 SNR（信号功率除以噪声功率）。

*************************
信号功率预算
*************************

下面的图展示了一个通用且基本的无线链路。
在本章中，我们主要关注从发射机（Tx）到接收机（Rx）的方向。
假设知道 **发射** 功率（通常由发射机主动设置），如何确定所接收到信号的功率（简称为 **接收功率** ）呢？

.. image:: ../_images/tx_rx_system.svg
   :align: center
   :target: ../_images/tx_rx_system.svg

我们将深入探讨四个参数以确定接收功率，以下是它们的定义和常见缩写：

- **Pt** - 发射功率
- **Gt** - 发射天线增益
- **Gr** - 接收天线增益
- **Lp** - 发射机（Tx）和接收机（Rx）之间的距离（即无线路径损耗）

.. image:: ../_images/tx_rx_system_params.svg
   :align: center
   :target: ../_images/tx_rx_system_params.svg
   :alt: Parameters within a link budget depicted

发射功率
#####################

传输功率比较直观易懂，它以 W（瓦特）、dBW 或 dBm（dBm 是 dBmW 的简写）作为单位来衡量。
每个发射机都配备一个或多个放大器，而传输功率主要取决于这些放大器的性能。
传输功率可以类比灯泡的功率瓦数，很显然高功率灯泡发出的光线更亮。
以下是不同技术示例的传输功率范围：

==================  =====  =======
\                       Power
------------------  --------------
蓝牙                 10mW  -20 dBW
WiFi                100mW  -10 dBW
LTE 基站             1W     0 dBW
FM 基站              10kW   40 dBW
==================  =====  =======

天线增益
#####################

链接预算中，发射/接收天线的增益（Gain）是非常重要的因素。
天线增益指的是天线的定向性，也被称为天线功率增益（Power Gain）。
天线的增益越高，就越能将能量定向到更集中的区域。

天线增益通常用分贝（dB）表示，这是一个无单位的量（具体原因可以在 :ref:`noise-chapter` 章节中了解或回顾）。
天线可以是全向的（Omnidirectional），即功率向各个方向辐射，它们的增益通常在 0 dB 至 3 dB 之间。
天线也可以是定向的（Directional），即功率在特定方向上辐射。所以它们的增益更高，通常为 5 dB 或更高，最高可以达到 60 dB 左右。

.. image:: ../_images/antenna_gain_patterns.png
   :scale: 80 %
   :align: center

使用定向天线时，必须将其安装在正确的朝向上，或连接到伺服/机械机构以控制方向。
也可以使用相控阵天线，它以软件定义的方式进行电子定向。

.. image:: ../_images/antenna_steering.png
   :scale: 80 %
   :align: center

当无法确定正确的方向时，例如对于手机和笔记本电脑这类设备，我们会采用全向天线。
然而，在 5G 中，手机可以利用一组天线和电子波束成形技术，在更高的频段（如 Verizon 的 28 GHz 和 AT&T 的 39 GHz）上进行通信。

在进行链路预算时，我们必须默认所有定向天线（发射和接收）都能正确指向目标。
如果没有正确指向（例如，当篮球撞击你屋顶上的卫星接收天线导致天线移动），链路预算将不准确，甚至可能导致通信中断。
总的来说，我们的链路预算假设了理想情况，并加入了杂散损耗以考虑实际因素。

路径损耗
#####################

当信号（电磁波）在空气（或真空）中传播时，在远处的接收机看来它会逐渐减弱。
假设你将一个小型太阳能电池板放在一个灯泡前面，然后逐渐将它离灯泡远去。
随着距离的增加，太阳能电池板从灯泡中吸收的能量也会减少。
物理学和数学中有一个术语叫做 **通量** ，它表示通过一个物体的某种量的数量。
在我们的情况下，通量指的是进入接收天线的电磁场的数量。
我们想要知道在给定的距离上会有多少功率损失，因而引出了本小节。

.. image:: ../_images/flux.png
   :scale: 80 %
   :align: center

自由空间路径损耗（Free Space Path Loss，缩写 FSPL）描述了在没有障碍物的情况下，给定距离上的信号损耗。
其数学定义为 :math:`\mathrm{FSPL} = (4\pi d / \lambda)^2` 。
你可以通过 Google 搜索 “ Friis 传输公式” 获取更多信息。
（有趣的是：信号在通过自由空间时，会遇到 377 欧姆的阻抗。）
为了进行链路预算计算，我们可以使用相同的方程，但将其转换为分贝数值的形式。

.. math::
 \mathrm{FSPL}_{dB} = 20 \log_{10} d + 20 \log_{10} f - 147.55 \left[ dB \right]

链路预算以 dB 显示是因为它是一种损耗（所以没有单位）。
发射机和接收机之间的距离 :math:`d` 以 m 为单位。载波频率 :math:`f` 以 Hz 为单位。
尽管上述简单方程是有效的，但它只适用于自由空间条件。
然而，在许多情况下，例如室内环境中，电磁波会经历多次反射。
虽然大多数频率下的电磁波可以穿过墙壁，但并不能穿过金属或厚砖墙。
为了解决这些非自由空间情况，我们可以使用其他的模型来进行链路预算。
Okumura-Hata 模型是城市和郊区（如蜂窝网络）中常用的模型之一：

.. math::
 L_{path} = 69.55 + 26.16 \log_{10} f - 13.82 \log_{10} h_B - C_H + \left[ 44.9 - 6.55 \log_{10} h_B \right] \log_{10} d

其中 :math:`L_{path}` 是路径损耗（dB），:math:`h_B` 是发射天线相对于地面高度（m），
:math:`f` 是载波频率（MHz），:math:`d` 是发射机（TX）和接收（RX）之间的距离（km），
:math:`C_H` 被称为 “天线高度修正因子” ，根据城市规模和载波频率范围来具体设定。

对于中小型城市，:math:`C_H` 设置为:

.. math::
 C_H = 0.8 + (1.1 \log_{10} f - 0.7 ) h_M - 1.56 \log_{10} f

对于大型城市，且载波频率 :math:`f` 低于 200MHz 时，:math:`C_H` 设为：

.. math::
 C_H = 8.29 ( log_{10}(1.54 h_M))^2 - 1.1

对于大型城市，且载波频率 :math:`f` 介于 200MHz 到 1.5GHz 之间时，:math:`C_H` 设为：

.. math::
 C_H = 3.2 ( log_{10}(11.75 h_M))^2 - 4.97

这里的 :math:`h_M` 表示接收天线离地面的高度（m）。

尽管 Okumura-Hata 模型可能有些令人困惑，但它只是用来展示非自由空间路径损耗模型相对于我们的简单自由空间路径损耗公式更为复杂。
无论使用哪种模型，最终我们都会得到一个数字用于表示链路预算中的路径损耗。
在接下来的章节中，我们将继续使用自由空间路径损耗（FSPL）公式。

杂项损耗
#####################

在链路预算中，我们还会考虑其他的损耗，将其合并为一项，通常在 1-3 dB 之间。这些杂项损耗包括：

- 电缆损耗
- 大气损耗
- 天线指向不准确
- 降水

下面的图表显示了频率范围内（通常低于 40 GHz）的单位距离上的大气损耗（以 dB/km 表示）。
如果你仔细观察 y 轴，你会发现在 40 GHz 以下且距离小于 1 公里的短距离通信中，大气损耗通常为 1 dB 或更低，因此我们通常忽略它。
对于卫星通信而言，大气损耗才变得十分重要，因为信号需要穿越大气层且传播距离很长。

.. image:: ../_images/atmospheric_attenuation.svg
   :align: center
   :target: ../_images/atmospheric_attenuation.svg
   :alt: Plot of atmospheric attenuation in dB/km over frequency showing the spikes from H2O (water) and O2 (oxygen)

信号功率方程
#####################

现在是时候将所有的增益和损失综合在一起，计算接收端的信号功率 :math:`P_r` 了。

.. math::
 P_r = P_t + G_t + G_r - L_p - L_{misc} \quad \mathrm{dBW}

总的来说，这是一个简单的方程，其中将收益和损失相加。
有些人甚至可能不把它视为一个方程。
通常我们会在表格中展示收益、损失和总计，和会计一样，如下所示：

.. list-table::
   :widths: 15 10
   :header-rows: 0

   * - :math:`P_t` = 1.0 W
     - 0 dBW
   * - :math:`G_t` = 100
     - 20.0 dB
   * - :math:`G_r` = 1
     - 0 dB
   * - :math:`L_p`
     - -162.0 dB
   * - :math:`L_{misc}`
     - -1.0 dB
   * - :math:`P_r`
     - **-143.0 dBW**

EIRP
#####

等效全向辐射功率（Effective Isotropic Radiated Power，EIRP）是衡量发射端信号实际传输效能的一个指标，
计算方式是 :math:`P_t + G_t - L_{cable}` ，其单位是分贝瓦（dBW）。
EIRP 是一个代表性数字，指出如果使用理想的全向天线，在天线 **主波束** 方向上获得相同信号强度所需要的 “假设” 辐射功率。
强调天线主波束方向这一点非常重要，因为只有当天线高增益（ :math:`G_t` ）得到正确指向的时候才能发挥最大效能。
因此，在链路预算的发射端，如果天线定向正确，那么 EIRP 就提供了所有必需的信息。
这也是为什么在诸如卫星地面站这类定向发射器的数据手册中常会看到 “最大 EIRP” 这样的指标。

*************************
噪声功率预算
*************************

在讨论完信号功率后，让我们转向讨论接收噪声，有了这两者之后就可以计算 SNR 了。
两者的计算方式也是类似的。

噪声是如何进入通信链路的？答案是：**接收机** !
只有当信号到达接收机后才会受到干扰，理解这一点 **非常** 重要！
许多学生并没有完全理解这一点，结果犯了一些错误。
空气中并没有漂浮的噪声，噪声的来源是接收机中的放大器和其他电子元件，毕竟它们不完美并且在非零开尔文（K）的温度下工作。

一个常见且简单的噪声预算公式是 “ kTB ” 方法：

.. math::
 P_{noise} = kTB

- :math:`k` – 玻尔兹曼常数 = 1.38 x 10-23 J/K = **-228.6 dBW/K/Hz** 。
  它是一个与气体中粒子的平均动能与气体的温度有关的物理常数。
- :math:`T` – 系统噪声温度，以 K 为单位，主要取决于链路中的放大器（Amplifier）。
  这是最难定量的一项，通常我们只会带入一个估计值。具有较低噪声温度的放大器一般更贵。
- :math:`B` – 信号带宽，以 Hz 为单位（假设信号带宽以外频段的噪声都已提前滤波消除）。
  举个例子，对于 10 MHz 宽的 LTE 下行信号，:math:`B` 将为 10 MHz （即 70 dBHz）。

将 kTB 三项的数值相乘（dB 的形式下则是相加）就得到了我们的噪声功率，即得到了信躁比（SNR）公式中的除数。

*************************
信噪比（SNR）
*************************

至此，我们已经讲述了如何计算 SNR 公式中的全部两项了，可以直接得到本体了！
（关于 SNR 更多介绍，请参阅 :ref:`noise-chapter` 章节。）

.. math::
   \mathrm{SNR} = \frac{P_{signal}}{P_{noise}}

.. math::
   \mathrm{SNR_{dB}} = P_{signal\_dB} - P_{noise\_dB}

通常，我们追求高于 10dB 的 SNR，尽管其确切值会根据具体应用而有所变化。
我们可以通过查看信号在接收机处的 FFT 结果或者对比有信号和无信号时接收机处的功率来验证SNR的取值。
SNR 越高，每个符号（Symbol）中可容纳的比特数就越多，从而减小出错的可能性。

***************************
链路预算案例：ADS-B
***************************

广播式自动相关监视（ADS-B）是一种由飞机使用的技术，通过广播信号与空中交通管制地面站和其他飞机共享位置和其他状态。
ADS-B 是自动的，不需要飞行员或外部输入，它依赖于飞机导航系统和其他计算机的数据。
这些消息没有加密。目前，澳大利亚部分领空要求使用ADS-B设备，而美国根据飞机大小要求部分飞机安装。

.. image:: ../_images/adsb.jpg
   :scale: 120 %
   :align: center

ADS-B 的物理层（PHY）有这些特征：

- 频点（中心频率）为 1,090 MHz
- 带宽大约为 2 MHz
- 使用脉冲相位调制（PPM Modulation）
- 数据传输速率为 1 Mbit/s，每个消息的长度在 56 至 112 微秒之间
- 每个消息携带 15 个字节的数据，因此通常需要多个消息来传输飞机的一次完整信息
- 消息广播的周期在 0.4 至 0.6 秒之间随机变化，旨在防止不同飞机的消息出现并发冲突（虽然随机化后仍可能发生碰撞，但是概率可接受）
- 使用垂直极化天线
- 发射功率变化不定，但在 100 瓦（20 dBW）左右
- 发射机天线增益是全向的，但只朝向下方，下文假设当 3 dB
- 接收机天线增益也是全向的，下文假设为 0 dB

路径损耗取决于飞机到接收机的距离。
举个例子，从马里兰大学（这本教材的家）到 BWI 机场大约有 30 公里。
我们可以计算在 1,090 MHz 下的自由空间路径损耗（FSPL）：

.. math::
    \mathrm{FSPL}_{dB} = 20 \log_{10} d + 20 \log_{10} f - 147.55  \left[ \mathrm{dB} \right]

    \mathrm{FSPL}_{dB} = 20 \log_{10} 30e3 + 20 \log_{10} 1090e6 - 147.55  \left[ \mathrm{dB} \right]

    \mathrm{FSPL}_{dB} = 122.7 \left[ \mathrm{dB} \right]

这个公式当然也能反过来用，把距离 :math:`d` 作为未知项，带入所需的 SNR 计算符合要求的距离。

由于自由空间（Free Space）并不存在，我们可以加上 3 dB 的杂项损耗。
考虑到天线、设备、电缆、连接器的损耗，还可以再加上 3 dB，最终得到 6 dB 的杂项损耗。
最终，信号链路预算如下:

.. list-table::
   :widths: 15 10
   :header-rows: 0

   * - :math:`P_t`
     - 20 dBW
   * - :math:`G_t`
     - 3 dB
   * - :math:`G_r`
     - 0 dB
   * - :math:`L_p`
     - -122.7 dB
   * - :math:`L_{misc}`
     - -6 dB
   * - :math:`P_r`
     - **-105.7 dBW**

噪声预算：

- B = 2 MHz = 2e6 = 63 dBHz
- T 的值只能近似估计一个，假设为 300 K（24.8 dBK）。  这个值在真实条件下会基于接收机的质量而不同。
- k 始终为 228.6 dBW/K/Hz

.. math::
 P_{noise} = k + T + B = -140.8 \quad \mathrm{dBW}

因此我们的信噪比是 -105.7 - (-140.8) = 35.1 dB。
得到这么大的结果并不奇怪，毕竟我们在计算中假设飞机距离我们仅 30 公里。
如果这个距离下 ADS-B 信号不强的话，它的实用性也就不存在了：飞机很近了才能感知到彼此。
这个例子的假设条件还是比较理想的，脉冲位置调制（PPM）相当稳健，也压根无需这么大的 SNR。
但在真实情况下，例如使用不合适的天线随意放置在接收机上，并在教室里接收 ADS-B 信号，
附近有一个强大的 FM 广播电台引起干扰，这种情况下损耗可以轻松达到 20-30 dB。

尽管这个例子只是一个草稿计算，但它展示了创建链路预算和理解通信链路的重要参数的基础知识。